<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediSafe - Ejemplo de Fetch desde Cliente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .api-section {
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background-color: #f8f9fa;
        }
        .response-box {
            background-color: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="text-center mb-4">
            <i class="bi bi-database me-2"></i>MediSafe - Ejemplo de Fetch desde Cliente
        </h1>
        
        <!-- Estado de conexi√≥n -->
        <div class="api-section">
            <h3><i class="bi bi-wifi me-2"></i>Estado de Conexi√≥n</h3>
            <div id="connection-status">
                <p><strong>Servidor:</strong> <span id="server-status">Verificando...</span></p>
                <p><strong>Token:</strong> <span id="token-status">No disponible</span></p>
                <p><strong>Usuario:</strong> <span id="user-status">No autenticado</span></p>
            </div>
            <button id="check-connection-btn" class="btn btn-info">
                <i class="bi bi-arrow-clockwise me-2"></i>Verificar Conexi√≥n
            </button>
        </div>
        
        <!-- Autenticaci√≥n -->
        <div class="api-section">
            <h3><i class="bi bi-person-circle me-2"></i>Autenticaci√≥n</h3>
            
            <div class="row">
                <div class="col-md-6">
                    <h5>Registro</h5>
                    <form id="register-form">
                        <div class="mb-3">
                            <label for="reg-username" class="form-label">Usuario</label>
                            <input type="text" class="form-control" id="reg-username" required>
                        </div>
                        <div class="mb-3">
                            <label for="reg-password" class="form-label">Contrase√±a</label>
                            <input type="password" class="form-control" id="reg-password" required>
                        </div>
                        <div class="mb-3">
                            <label for="reg-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="reg-email" required>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-person-plus me-2"></i>Registrar
                        </button>
                    </form>
                </div>
                
                <div class="col-md-6">
                    <h5>Inicio de Sesi√≥n</h5>
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="login-username" class="form-label">Usuario</label>
                            <input type="text" class="form-control" id="login-username" required>
                        </div>
                        <div class="mb-3">
                            <label for="login-password" class="form-label">Contrase√±a</label>
                            <input type="password" class="form-control" id="login-password" required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Iniciar Sesi√≥n
                        </button>
                    </form>
                    
                    <button id="logout-btn" class="btn btn-warning mt-3">
                        <i class="bi bi-box-arrow-left me-2"></i>Cerrar Sesi√≥n
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Medicamentos -->
        <div class="api-section">
            <h3><i class="bi bi-capsule me-2"></i>Medicamentos</h3>
            
            <div class="row">
                <div class="col-md-6">
                    <h5>Crear Medicamento</h5>
                    <form id="medication-form">
                        <div class="mb-3">
                            <label for="med-name" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="med-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="med-dose" class="form-label">Dosis</label>
                            <input type="text" class="form-control" id="med-dose" required>
                        </div>
                        <div class="mb-3">
                            <label for="med-freq" class="form-label">Frecuencia</label>
                            <input type="text" class="form-control" id="med-freq" required>
                        </div>
                        <div class="mb-3">
                            <label for="med-time" class="form-label">Horario</label>
                            <input type="time" class="form-control" id="med-time" required>
                        </div>
                        <div class="mb-3">
                            <label for="med-expiry" class="form-label">Fecha de caducidad</label>
                            <input type="date" class="form-control" id="med-expiry" required>
                        </div>
                        <div class="mb-3">
                            <label for="med-notes" class="form-label">Notas</label>
                            <textarea class="form-control" id="med-notes" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-plus-circle me-2"></i>Crear Medicamento
                        </button>
                    </form>
                </div>
                
                <div class="col-md-6">
                    <h5>Acciones</h5>
                    <button id="load-medications-btn" class="btn btn-info mb-2">
                        <i class="bi bi-list me-2"></i>Cargar Medicamentos
                    </button>
                    <button id="test-medication-btn" class="btn btn-warning mb-2">
                        <i class="bi bi-flask me-2"></i>Test Medicamento
                    </button>
                </div>
            </div>
            
            <div id="medications-list" class="mt-3">
                <h6>Medicamentos:</h6>
                <div id="medications-display">No hay medicamentos cargados</div>
            </div>
        </div>
        
        <!-- Recordatorios -->
        <div class="api-section">
            <h3><i class="bi bi-bell me-2"></i>Recordatorios</h3>
            
            <div class="row">
                <div class="col-md-6">
                    <h5>Crear Recordatorio</h5>
                    <form id="reminder-form">
                        <div class="mb-3">
                            <label for="reminder-title" class="form-label">T√≠tulo</label>
                            <input type="text" class="form-control" id="reminder-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="reminder-description" class="form-label">Descripci√≥n</label>
                            <textarea class="form-control" id="reminder-description" rows="2" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="reminder-date" class="form-label">Fecha</label>
                            <input type="date" class="form-control" id="reminder-date" required>
                        </div>
                        <div class="mb-3">
                            <label for="reminder-time" class="form-label">Hora</label>
                            <input type="time" class="form-control" id="reminder-time" required>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-plus-circle me-2"></i>Crear Recordatorio
                        </button>
                    </form>
                </div>
                
                <div class="col-md-6">
                    <h5>Acciones</h5>
                    <button id="load-reminders-btn" class="btn btn-info mb-2">
                        <i class="bi bi-list me-2"></i>Cargar Recordatorios
                    </button>
                    <button id="test-reminder-btn" class="btn btn-warning mb-2">
                        <i class="bi bi-bell me-2"></i>Test Recordatorio
                    </button>
                </div>
            </div>
            
            <div id="reminders-list" class="mt-3">
                <h6>Recordatorios:</h6>
                <div id="reminders-display">No hay recordatorios cargados</div>
            </div>
        </div>
        
        <!-- Metas -->
        <div class="api-section">
            <h3><i class="bi bi-target me-2"></i>Metas</h3>
            
            <div class="row">
                <div class="col-md-6">
                    <h5>Crear Meta</h5>
                    <form id="goal-form">
                        <div class="mb-3">
                            <label for="goal-title" class="form-label">T√≠tulo</label>
                            <input type="text" class="form-control" id="goal-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="goal-description" class="form-label">Descripci√≥n</label>
                            <textarea class="form-control" id="goal-description" rows="2" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="goal-target-date" class="form-label">Fecha Objetivo</label>
                            <input type="date" class="form-control" id="goal-target-date" required>
                        </div>
                        <div class="mb-3">
                            <label for="goal-priority" class="form-label">Prioridad</label>
                            <select class="form-control" id="goal-priority" required>
                                <option value="baja">Baja</option>
                                <option value="media">Media</option>
                                <option value="alta">Alta</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-plus-circle me-2"></i>Crear Meta
                        </button>
                    </form>
                </div>
                
                <div class="col-md-6">
                    <h5>Acciones</h5>
                    <button id="load-goals-btn" class="btn btn-info mb-2">
                        <i class="bi bi-list me-2"></i>Cargar Metas
                    </button>
                    <button id="test-goal-btn" class="btn btn-warning mb-2">
                        <i class="bi bi-target me-2"></i>Test Meta
                    </button>
                </div>
            </div>
            
            <div id="goals-list" class="mt-3">
                <h6>Metas:</h6>
                <div id="goals-display">No hay metas cargadas</div>
            </div>
        </div>
        
        <!-- Respuestas de la API -->
        <div class="api-section">
            <h3><i class="bi bi-code-slash me-2"></i>Respuestas de la API</h3>
            <div id="api-response" class="response-box">
                Esperando peticiones...
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- API Client -->
    <script src="client-fetch-examples.js"></script>
    
    <script>
        // Funci√≥n para mostrar respuestas de la API
        function showAPIResponse(data, endpoint) {
            const responseBox = document.getElementById('api-response');
            const timestamp = new Date().toLocaleTimeString();
            responseBox.innerHTML += `[${timestamp}] ${endpoint}:\n${JSON.stringify(data, null, 2)}\n\n`;
            responseBox.scrollTop = responseBox.scrollHeight;
        }
        
        // Funci√≥n para actualizar estado
        function updateStatus() {
            const token = localStorage.getItem('token');
            const serverStatus = document.getElementById('server-status');
            const tokenStatus = document.getElementById('token-status');
            const userStatus = document.getElementById('user-status');
            
            if (token) {
                tokenStatus.textContent = 'Disponible';
                userStatus.textContent = 'Autenticado';
            } else {
                tokenStatus.textContent = 'No disponible';
                userStatus.textContent = 'No autenticado';
            }
        }
        
        // Verificar conexi√≥n
        async function checkConnection() {
            try {
                const response = await fetch('http://localhost:3000/api/health');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('server-status').textContent = 'Conectado';
                    showAPIResponse(data, 'Health Check');
                } else {
                    document.getElementById('server-status').textContent = 'Error';
                }
            } catch (error) {
                document.getElementById('server-status').textContent = 'No conectado';
                console.error('Error de conexi√≥n:', error);
            }
        }
        
        // Configurar event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Configurando event listeners...');
            
            // Verificar conexi√≥n inicial
            checkConnection();
            updateStatus();
            
            // Bot√≥n verificar conexi√≥n
            document.getElementById('check-connection-btn').addEventListener('click', checkConnection);
            
            // Formulario de registro
            document.getElementById('register-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('reg-username').value;
                const password = document.getElementById('reg-password').value;
                const email = document.getElementById('reg-email').value;
                
                try {
                    const result = await MediSafeAPI.registerUser(username, password, email);
                    showAPIResponse(result, 'Register User');
                    updateStatus();
                    MediSafeAPI.showNotification('‚úÖ Usuario registrado exitosamente', 'success');
                } catch (error) {
                    MediSafeAPI.showNotification(`‚ùå Error: ${error.message}`, 'error');
                }
            });
            
            // Formulario de login
            document.getElementById('login-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                
                try {
                    const result = await MediSafeAPI.loginUser(username, password);
                    showAPIResponse(result, 'Login User');
                    updateStatus();
                    MediSafeAPI.showNotification('‚úÖ Login exitoso', 'success');
                } catch (error) {
                    MediSafeAPI.showNotification(`‚ùå Error: ${error.message}`, 'error');
                }
            });
            
            // Bot√≥n logout
            document.getElementById('logout-btn').addEventListener('click', function() {
                localStorage.removeItem('token');
                updateStatus();
                MediSafeAPI.showNotification('üëã Sesi√≥n cerrada', 'info');
            });
            
            // Formulario de medicamentos
            document.getElementById('medication-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const medicationData = {
                    name: document.getElementById('med-name').value,
                    dose: document.getElementById('med-dose').value,
                    frequency: document.getElementById('med-freq').value,
                    time: document.getElementById('med-time').value,
                    expiry_date: document.getElementById('med-expiry').value,
                    notes: document.getElementById('med-notes').value
                };
                
                try {
                    const result = await MediSafeAPI.createMedication(medicationData);
                    showAPIResponse(result, 'Create Medication');
                    MediSafeAPI.showNotification('‚úÖ Medicamento creado exitosamente', 'success');
                    this.reset();
                    loadMedications();
                } catch (error) {
                    MediSafeAPI.showNotification(`‚ùå Error: ${error.message}`, 'error');
                }
            });
            
            // Bot√≥n cargar medicamentos
            document.getElementById('load-medications-btn').addEventListener('click', loadMedications);
            
            // Bot√≥n test medicamento
            document.getElementById('test-medication-btn').addEventListener('click', async function() {
                const testMedication = {
                    name: 'Paracetamol Test',
                    dose: '500mg',
                    frequency: 'Cada 6 horas',
                    time: '08:00',
                    expiry_date: '2024-12-31',
                    notes: 'Medicamento de prueba'
                };
                
                try {
                    const result = await MediSafeAPI.createMedication(testMedication);
                    showAPIResponse(result, 'Test Medication');
                    MediSafeAPI.showNotification('‚úÖ Medicamento de prueba creado', 'success');
                    loadMedications();
                } catch (error) {
                    MediSafeAPI.showNotification(`‚ùå Error: ${error.message}`, 'error');
                }
            });
            
            // Formulario de recordatorios
            document.getElementById('reminder-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const reminderData = {
                    title: document.getElementById('reminder-title').value,
                    description: document.getElementById('reminder-description').value,
                    date: document.getElementById('reminder-date').value,
                    reminder_time: document.getElementById('reminder-time').value
                };
                
                try {
                    const result = await MediSafeAPI.createReminder(reminderData);
                    showAPIResponse(result, 'Create Reminder');
                    MediSafeAPI.showNotification('‚úÖ Recordatorio creado exitosamente', 'success');
                    this.reset();
                    loadReminders();
                } catch (error) {
                    MediSafeAPI.showNotification(`‚ùå Error: ${error.message}`, 'error');
                }
            });
            
            // Bot√≥n cargar recordatorios
            document.getElementById('load-reminders-btn').addEventListener('click', loadReminders);
            
            // Bot√≥n test recordatorio
            document.getElementById('test-reminder-btn').addEventListener('click', async function() {
                const testReminder = {
                    title: 'Tomar medicamento',
                    description: 'Recordatorio de prueba',
                    date: new Date().toISOString().split('T')[0],
                    reminder_time: '08:00'
                };
                
                try {
                    const result = await MediSafeAPI.createReminder(testReminder);
                    showAPIResponse(result, 'Test Reminder');
                    MediSafeAPI.showNotification('‚úÖ Recordatorio de prueba creado', 'success');
                    loadReminders();
                } catch (error) {
                    MediSafeAPI.showNotification(`‚ùå Error: ${error.message}`, 'error');
                }
            });
            
            // Formulario de metas
            document.getElementById('goal-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const goalData = {
                    title: document.getElementById('goal-title').value,
                    description: document.getElementById('goal-description').value,
                    target_date: document.getElementById('goal-target-date').value,
                    priority: document.getElementById('goal-priority').value
                };
                
                try {
                    const result = await MediSafeAPI.createGoal(goalData);
                    showAPIResponse(result, 'Create Goal');
                    MediSafeAPI.showNotification('‚úÖ Meta creada exitosamente', 'success');
                    this.reset();
                    loadGoals();
                } catch (error) {
                    MediSafeAPI.showNotification(`‚ùå Error: ${error.message}`, 'error');
                }
            });
            
            // Bot√≥n cargar metas
            document.getElementById('load-goals-btn').addEventListener('click', loadGoals);
            
            // Bot√≥n test meta
            document.getElementById('test-goal-btn').addEventListener('click', async function() {
                const testGoal = {
                    title: 'Mejorar salud',
                    description: 'Meta de prueba',
                    target_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    priority: 'media'
                };
                
                try {
                    const result = await MediSafeAPI.createGoal(testGoal);
                    showAPIResponse(result, 'Test Goal');
                    MediSafeAPI.showNotification('‚úÖ Meta de prueba creada', 'success');
                    loadGoals();
                } catch (error) {
                    MediSafeAPI.showNotification(`‚ùå Error: ${error.message}`, 'error');
                }
            });
            
            console.log('‚úÖ Todos los event listeners configurados');
        });
        
        // Funciones de carga de datos
        async function loadMedications() {
            try {
                const medications = await MediSafeAPI.getMedications();
                showAPIResponse(medications, 'Get Medications');
                
                const display = document.getElementById('medications-display');
                if (medications.length === 0) {
                    display.innerHTML = '<p class="text-muted">No hay medicamentos registrados.</p>';
                    return;
                }
                
                let html = '<div class="list-group">';
                medications.forEach(med => {
                    html += `
                        <div class="list-group-item">
                            <h6 class="mb-1">${med.name}</h6>
                            <p class="mb-1">Dosis: ${med.dose} | Frecuencia: ${med.frequency} | Hora: ${med.time}</p>
                            <small class="text-muted">Caducidad: ${med.expiry_date}</small>
                        </div>
                    `;
                });
                html += '</div>';
                
                display.innerHTML = html;
            } catch (error) {
                MediSafeAPI.showNotification(`‚ùå Error cargando medicamentos: ${error.message}`, 'error');
            }
        }
        
        async function loadReminders() {
            try {
                const reminders = await MediSafeAPI.getReminders();
                showAPIResponse(reminders, 'Get Reminders');
                
                const display = document.getElementById('reminders-display');
                if (reminders.length === 0) {
                    display.innerHTML = '<p class="text-muted">No hay recordatorios registrados.</p>';
                    return;
                }
                
                let html = '<div class="list-group">';
                reminders.forEach(reminder => {
                    html += `
                        <div class="list-group-item">
                            <h6 class="mb-1">${reminder.title}</h6>
                            <p class="mb-1">${reminder.description}</p>
                            <small class="text-muted">Fecha: ${reminder.date} ${reminder.reminder_time}</small>
                        </div>
                    `;
                });
                html += '</div>';
                
                display.innerHTML = html;
            } catch (error) {
                MediSafeAPI.showNotification(`‚ùå Error cargando recordatorios: ${error.message}`, 'error');
            }
        }
        
        async function loadGoals() {
            try {
                const goals = await MediSafeAPI.getGoals();
                showAPIResponse(goals, 'Get Goals');
                
                const display = document.getElementById('goals-display');
                if (goals.length === 0) {
                    display.innerHTML = '<p class="text-muted">No hay metas registradas.</p>';
                    return;
                }
                
                let html = '<div class="list-group">';
                goals.forEach(goal => {
                    html += `
                        <div class="list-group-item">
                            <h6 class="mb-1">${goal.title}</h6>
                            <p class="mb-1">${goal.description}</p>
                            <small class="text-muted">Objetivo: ${goal.deadline} | Prioridad: ${goal.priority}</small>
                        </div>
                    `;
                });
                html += '</div>';
                
                display.innerHTML = html;
            } catch (error) {
                MediSafeAPI.showNotification(`‚ùå Error cargando metas: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html> 